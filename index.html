<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Click-to-Call Webex Contact Center</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    label, input, button { font-size: 16px; margin-top: 10px; display: block; }
    #status { margin-top: 20px; font-weight: bold; }
  </style>
</head>
<body>
  <h1>Click-to-Call con Webex Contact Center</h1>

  <label for="guestName">Tu nombre:</label>
  <input type="text" id="guestName" placeholder="Ingresa tu nombre" />

  <button id="callBtn">Llamar ahora</button>

  <div id="status"></div>

  <!-- SDK Webex -->
  <script src="https://binaries.webex.com/WxCCWidgets/guest-widgets.min.js"></script>

  <script>
    const callBtn = document.getElementById('callBtn');
    const guestNameInput = document.getElementById('guestName');
    const statusDiv = document.getElementById('status');

    // Configuraci√≥n de Webex - debes cambiar TU_ORG_ID por tu ID real
    const webexConfig = {
      orgId: 'TU_ORG_ID'
    };

    let call; // variable global para la llamada

    callBtn.addEventListener('click', async () => {
      const guestName = guestNameInput.value.trim();
      if (!guestName) {
        alert("Por favor ingresa tu nombre");
        return;
      }

      statusDiv.textContent = 'Obteniendo token para la llamada...';

      try {
        // Llama a tu backend para obtener el token JWE (cambia la URL a la correcta)
        const response = await fetch('http://localhost:3000/api/jwe-token');
        const data = await response.json();
        const jweToken = data.token;

        if (!jweToken) throw new Error("No se obtuvo token JWE");

        statusDiv.textContent = "Inicializando llamada...";

        // Configuraci√≥n para el cliente de llamada
        const callingClientConfig = {
          logger: { level: 'INFO' },
          serviceData: {
            indicator: 'guestcalling',
            guestName: guestName
          },
          jwe: jweToken
        };

        const clientConfig = {};

        const callingConfig = {
          clientConfig,
          callingClientConfig,
          logger: { level: 'INFO' }
        };

        // Inicializar el SDK de llamada
        const calling = await Calling.init({ webexConfig, callingConfig });

        calling.on('ready', async () => {
          statusDiv.textContent = 'Registrando l√≠nea...';

          await calling.register();

          const callingClient = calling.callingClient;
          const lines = callingClient.getLines();
          const line = Object.values(lines)[0];

          line.on('registered', async () => {
            statusDiv.textContent = 'L√≠nea registrada, iniciando llamada...';

            const localAudioStream = await Calling.createMicrophoneStream({ audio: true });

            call = line.makeCall();

            call.on('connected', () => {
              statusDiv.textContent = 'üìû Llamada conectada';
            });

            call.on('disconnected', () => {
              statusDiv.textContent = 'üì¥ Llamada finalizada';
            });

            call.on('failed', () => {
              statusDiv.textContent = '‚ùå Llamada fallida';
            });

            call.dial({ localAudioStream });
          });

          await line.register();
        });
      } catch (error) {
        console.error(error);
        statusDiv.textContent = 'Error: ' + error.message;
      }
    });
  </script>
</body>
</html>
